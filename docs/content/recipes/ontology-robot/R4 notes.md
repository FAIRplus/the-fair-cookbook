# R4 Dev Notes 
The following folder structure has been created in order to keep organized the intermediate artifacts generated along the development of the recipe.

* `dataset` folder contains a CSV version of the datataset.
* `onto_sources` folder contains the ontology selected as sources of the branch extraction task.
* `jup_notebooks` folder contains a set jupyter lab notebooks developed to automate the generation of the seed terms needed to perform the branch extraction.
* `seed_files` folder contains (1) a set of files listing the seed terms used to perform branch extraction, and (2) a set of files listing the terms that couldn't be mapped to ontology concepts by means of the jupyter lab notebook.
* `extracted_branches` folder contains the ontology branches obtained from the branch extraction task.
* `onto_results` folder contains the application ontologies obtained.
* `templates` folder contains the ROBOT templates used to create ontology entities (classes and properties).

#### Notes:
* The document shows Windows commands.
* The paths shown in this document are relative to the `dev_artifacts` Google Drive folder (https://drive.google.com/open?id=1kY_oBDJvs901vNS_NKM7EFoozIXlWK9k). The artifacts were not versioned on the GitHub platform because I haven't the permission to push large files (ontologies).  
* Using Protege or a local deployment of OLS (Recipe 1.3) to show the results. Protege die when the ontology is pretty big.
* I also develop a jupyter notebook using the Zooma Annotator API service, but I couldn't test it because Zooma was died.
* A cleaning of the spreadsheet is needed. I can recognize similarities and erroneous values at the `gender` feature, but I'm not able to do that at - for example - the `disease` column.
* It's neeeded a guideline on how to map the umbrella concepts  - i.e., gender, species, diseases, cell line, etc. - with the root concept of each extracted branch. E.g., `biological sex` is the root concept of the PATO branch, but `gender` is the label of its associated spreadsheet column.
* The NCBITaxon ontology uses different root URI depending the portal which it is downloaded from (i.e., Zooma or NCBO BioPortal). 

# Branch extraction task
## GENDER column
### Get the PATO source ontology
```
wget -Uri http://purl.obolibrary.org/obo/pato.owl -OutFile .\onto_sources\pato.owl
```
### First try
Extract the terms, using the MIREOT method with minimal intermediates.
#### ROBOT command
```
robot extract --method MIREOT ,
--input .\onto_sources\pato.owl ,
--upper-term "PATO:0000047" ,
--lower-term "PATO:0000384" ,
--lower-term "PATO:0000383" ,
--intermediates minimal ,
--output .\extracted_branches\gender_branch_1.owl
```
#### Branch extracted
Available at `./extracted_branches/gender_branch_1.owl`

### Second try
Following @Danielle suggestion _"get the full biological sex branch"_
#### ROBOT command
```
robot extract --method MIREOT ,
--input .\onto_sources\pato.owl ,
--branch-from-term "PATO:0000047" ,
--output .\extracted_branches\gender_branch_2.owl
```
#### Branch extracted
Available at `./extracted_branches/gender_branch_2.owl`

### Third try
Using the seeds file `gender_seeds.txt` which is automatically generated by running the `bioportal-annotator` jupyter notebook.
Extract the terms, using the MIREOT method with the automatically extracted terms as lower limit.
#### ROBOT command
```
robot extract --method MIREOT ,
--input .\onto_sources\pato.owl ,
--lower-terms .\seed_files\gender_seeds.txt ,
--output .\extracted_branches\gender_branch_3.owl
```
#### Branch extracted
Available at `./extracted_branches/gender_branch_3.owl`

## SPECIES column
### Get the NCBITAXON source ontology
```
wget -Uri http://purl.obolibrary.org/obo/ncbitaxon.owl -OutFile .\onto_sources\ncbitaxon.owl
```
### First try
Extract the terms, using the MIREOT method with minimal intermediates.
#### ROBOT command
```
robot extract --method MIREOT ,
--input .\onto_sources\ncbitaxon.owl ,
--upper-term "NCBITaxon:2759" ,
--lower-term "NCBITaxon:9606" ,
--lower-term "NCBITaxon:10090" ,
--lower-term "NCBITaxon:10116" ,
--intermediates minimal ,
--output .\extracted_branches\species_branch_1.owl
```
:bulb: *Very large ontology. It is needed to increase the Java Heap space.*
```
java -Xmx12000m -jar [FULLPATH TO ROBOT JAR FILE] extract --method MIREOT ,
--input .\onto_sources\ncbitaxon.owl ,
--upper-term "NCBITaxon:2759" ,
--lower-term "NCBITaxon:9606" ,
--lower-term "NCBITaxon:10090" ,
--lower-term "NCBITaxon:10116" ,
--intermediates minimal ,
--output .\extracted_branches\species_branch_1.owl
```
#### Branch extracted
Available at `.\extracted_branches\species_branch_1.owl`

### Second try
Using the seeds file `species_seeds.txt` which is automatically generated by running the `bioportal-annotator` jupyter notebook. 
Extract the terms, using the MIREOT method with the automatically extracted terms.
#### ROBOT command
```
java -Xmx12000m -jar [FULLPATH TO ROBOT JAR FILE] extract --method MIREOT ,
--input .\onto_sources\ncbitaxon.owl ,
--lower-terms .\seed_files\species_seeds.txt
--intermediates minimal ,
--output .\extracted_branches\species_branch_2.owl
```
#### Branch extracted
Weird results here.
The obtained ontology - available at `.\extracted_branches\species_branch_2.owl` - is empty.
By inspecting the `species_seeds.txt` file, the NCBO BioPortal, and the OBO Foundry portal, it can be noted that there are two versions of the same ontology. An OBO version with the root URI http://purl.obolibrary.org/obo/, and a NCBO version with the root URI http://purl.bioontology.org/ontology/NCBITAXON/. 
Given that the `bioportal-annotator` notebook is based on the NCBO BioPortal Annotator API service, the annotations serialized in the `species_seeds.txt` file use the NCBO version's URI. But the source ontology used to perform the branch extraction has been downloaded from the OLS portal, and it uses the NCBO version's URI. In consequence, the branch extraction task get an empty ontology as a result. 

##### Workaround
To manually replace the BIO-based URIs for the OBO-based URIs on the `species_seeds.txt` file. Manually updated file is availabel at `.\seed_files\species_seeds_wa.txt`. Then, run the following ROBOT command:
```
java -Xmx12000m -jar [FULLPATH TO ROBOT JAR FILE] extract --method MIREOT ,
--input .\onto_sources\ncbitaxon.owl ,
--lower-terms .\seed_files\species_seeds_wa.txt
--intermediates minimal ,
--output .\extracted_branches\species_branch_2_wa.owl
```
Branch extracted is available at `.\extracted_branches\species_branch_2_wa.owl`

## DISEASE column
### Get the MONDO source ontology
```
wget -Uri http://purl.obolibrary.org/obo/mondo.owl -OutFile .\onto_sources\mondo.owl
```
### First try
Extract the full `disease or disorder` MONDO's branch, using the SLME TOP method.
#### ROBOT command  
```
robot extract --method TOP ,
--input .\onto_sources\mondo.owl ,
--term "MONDO:0000001" ,
--output .\extracted_branches\disease_branch_1.owl
```
#### Branch extracted
Weird results obtained!
Available at `.\extracted_branches\disease_branch_1.owl`

### Second try
Extract the terms, using the MIREOT method with minimal intermediates
#### ROBOT command
```
robot extract --method MIREOT ,
--input .\onto_sources\mondo.owl ,
--branch-from-term "MONDO:0000001" ,
--intermediates minimal ,
--output .\extracted_branches\disease_branch_2.owl
```
#### Branch extracted
Expected results this time.
Available at `.\extracted_branches\disease_branch_2.owl`

### Third try
Following @Danielle suggestion, using seed file provided by her and available at `.\seed_files\disease_seeds_danielle.txt`.
Extract the terms, using the BOT seed feeded method.
#### ROBOT command
```
robot extract --method BOT ,
--input .\onto_sources\mondo.owl ,
--term-file .\seed_files\disease_seeds_danielle.txt ,
--output .\extracted_branches\disease_branch_3.owl
```
#### Branch extracted
Interesting results this time.
Available at `.\extracted_branches\disease_branch_3.owl`

### Fourth try
Using the seeds file `disease_seeds.txt` which is automatically generated by running the `bioportal-annotator` jupyter notebook. 
Extract the terms, using the BOT method with the automatically extracted terms.
#### ROBOT command
```
robot extract --method BOT ,
--input .\onto_sources\mondo.owl ,
--term-file .\seed_files\disease_seeds.txt ,
--output .\extracted_branches\disease_branch_4.owl
```
#### Branch extracted
Available at `.\extracted_branches\disease_branch_4.owl`

## TISSUE column
### Get the MONDO source ontology
```
wget -Uri http://purl.obolibrary.org/obo/uberon.owl -OutFile .\onto_sources\uberon.owl
```
### First try
Extract the seed terms automatically obtained by means of the `bioportal-annotator` jupyter notebook, using the SLME BOT method.

#### ROBOT command  
```
robot extract --method BOT ,
--input .\onto_sources\uberon.owl ,
--term-file .\seed_files\tissue_seeds.txt ,
--output .\extracted_branches\tissue_branch_1.owl
```
#### Branch extracted
Available at `.\extracted_branches\tissue_branch_1.owl`

## CELL column
### Get the MONDO source ontology
```
wget -Uri http://purl.obolibrary.org/obo/cl.owl -OutFile .\onto_sources\cl.owl
```

### First stry
Not to perform branch extraction. The root branch concept is the root ontology concept. Then, the `.\extracted_branches\cell_branch_1.owl` is the same as `.\onto_sources\cl.owl.`

### Second try
Extract the seed terms automatically obtained by means of the `bioportal-annotator` jupyter notebook, using the BOT method with minimal intermediates.
#### ROBOT command  
```
robot extract --method BOT ,
--input .\onto_sources\cl.owl ,
--term-file .\seed_files\cell_seeds.txt ,
--intermediates minimal ,
--output .\extracted_branches\cell_branch_2.owl
```
#### Branch extracted
Available at `.\extracted_branches\cell_branch_2.owl`

## CELL LINE column
### Get the MONDO source ontology
```
wget -Uri http://purl.obolibrary.org/obo/clo.owl -OutFile .\onto_sources\clo.owl
```
### First try
No seed terms automatically obtained by means of the `bioportal-annotator` jupyter notebook. Then, full branch extracted from the CLO:0000031 (cell line) concept using the MIREOT method.
#### ROBOT command
```
robot extract --method MIREOT ,
--input .\onto_sources\clo.owl ,
--branch-from-term "CLO:0000031" ,
--output .\extracted_branches\cellline_branch_1.owl
```
#### Branch extracted
Available at `.\extracted_branches\cellline_branch.owl`

# Branch merging task
Following table presents the mapping of domain ontology classes to data headers (_aka columns_) and the selected branch to perform the merging.

| Dataset column | Source ontology | Ontology Concept Mapping | Comments | Branch |
| -------- | -------- | -------- | -------- | -------- |
| Sample | Semanticscience Integrated Ontology (SIO) | SIO:001050 (sample) |--------|--------|
| Study | Semanticscience Integrated Ontology (SIO) | SIO:001066 (study) |--------|--------|
| Source ID | -------- | -------- | Attribute (alphanumeric string)|--------|
| Sample description | -------- | -------- | Attribute (rdfs:label) |--------|
| Tissue | Uber-anatomy ontology (UBERON) | UBERON:0001062 (anatomical entity) |--------|First try (tissue_branch_1.owl)
| Source tissue | Uber-anatomy ontology (UBERON) | UBERON:0001062 (anatomical entity) |--------|First try (tissue_branch_1.owl)|
| Cell | Cell Ontology (CL) | CL:0000000 (cell) | -------- | Second try (cell_branch_2.owl) | 
| Cell line | Cell Line Ontology (CLO) | CLO:0000031 (cell line) | -------- | First try (cellline_branch_1.owl) | 
| Disease | Mondo Disease Ontology (MONDO) | MONDO:0000001 (disease or disorder) | -------- | Fourth try (disease_branch_4.owl) | 
| Gender | The Phenotype And Trait Ontology (PATO) | PATO:0000047 (biological sex) | -------- | Second try (gender_branch_2.owl) | 
| Specie | NCBI organismal classification | NCBITaxon:2759 (eukaryota) | -------- | First try (species_branch_1.owl) | 

## Strategy 1. The simple approach
### Overview
Simple, lightweight, and quick approach. It only requires the domain expert identifying the domain ontologies and the root classes for each dataset feature. Then, only the _umbrella ontology_ is developed, comprising:
1. the main entity (sample),
2. its features (study, tissue, disease, etc.),
3. the relationships among the main entity and its features, and
4. subclassing composition of relationships among the main entity and its features, with the ontology sources identified by the domain expert.

**Highlights**
* Population of the ontology requires to identify the class to instantiate from the domain ontology specialized by a given feature. I.e.: if an instance has the `Male` value at the `gender` feature, then it requires to instantiate the `PATO_0000384 ` domain ontology class.

### ROBOT command
```
robot template --template ./templates/s1.tsv ,
  --prefix "R4: https://fairplus-project.eu/ontologies/R4/" ,
  --ontology-iri "https://fairplus-project.eu/ontologies/R4" ,
  --version-iri "https://fairplus-project.eu/ontologies/R4/0.1/" ,
  --output ./onto_results/s1.owl
```

### Ontology obtained
Available at `.onto_results\s1.owl`

![](https://i.imgur.com/Cjlqclj.png)

## Strategy 2. The pretty some complex approach
### Overview
**@Danielle's sugestion #1.** Using the mapping table before presented as a set of orthogonal branches under owl:Thing. This is the way a lot of biomedical ontologies operate, both in the domain and application space (see Uberon, CL and EFO as examples)
### ROBOT command

#### Step 1. Merge all ranches
```
robot merge --include-annotations true ,
  --input ./extracted_branches/tissue_branch_1.owl ,
  --input ./extracted_branches/cell_branch_2.owl ,
  --input ./extracted_branches/cellline_branch_1.owl ,
  --input ./extracted_branches/disease_branch_4.owl ,
  --input ./extracted_branches/gender_branch_2.owl ,
  --input ./extracted_branches/species_branch_1.owl ,
  annotate --ontology-iri "https://fairplus-project.eu/ontologies/R4" ,
  --output ./onto_results/s2-pre.owl
```
Available intermediate results a `./onto_results/s2-pre.owl`

#### Step 2. Create app ontology main concept and relationships from template and merge with Step 1 results
```
robot template --merge-before ,
  --input ./onto_results/s2-pre.owl ,
  --template ./templates/s2.tsv ,
  --prefix "R4: https://fairplus-project.eu/ontologies/R4/" ,
  --version-iri "https://fairplus-project.eu/ontologies/R4/0.1/" ,
  --output ./onto_results/s2.owl
```

### Ontology obtained
Available at `.onto_results\s2.owl`

![](https://i.imgur.com/Wddb74u.png)

## Strategy 3. The complex approach
**@Danielle's sugestion #2.** Fitting all the ontologies under a BFO upper:
1. For PATO: map the PATO root (quality - PATO:0000001) to the BFO equivalent (quality - BFO:0000019)
2. For Uberon: you’ll have to use the subclasses of Uberon:0001062 (anatomical entity) in the correct places (material vs immaterial entities)
3. CL - already BFO-compliant as per your cell branch
4. CLO - conforms to BFO upper
5. MONDO - put disease under BFO:0000016 (disposition)
6. NCBITaxon - use OBI - organism (OBI:0100026) as guidance